<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>vogue-shein</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="app-script" type="text/plain" data-src="./assets/index-Bz4wWbGl.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-CidzUtdd.css">
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Client helper to persist data to the new backend API.
      (function(){
        async function apiFetch(path, options = {}){
          const res = await fetch(path, options);
          if(res.status === 401){
            // si no está autenticado, limpiar sesión local
            localStorage.removeItem('vogue_sesion');
            localStorage.removeItem('vogue_user');
          }
          return res;
        }

        const api = {
          login: async (username, password) => {
            const res = await apiFetch('/api/login', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ username, password })
            });
            return res.json();
          },
          logout: async () => {
            const res = await apiFetch('/api/logout', { method:'POST' });
            return res.json();
          },
          me: async () => {
            const res = await apiFetch('/api/me');
            return res.json();
          },
          save: async (key, value) => {
            const res = await apiFetch('/api/save', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ key, value })
            });
            return res.json();
          },
          load: async (key) => {
            const res = await apiFetch('/api/load?key=' + encodeURIComponent(key));
            return res.json();
          },
          addItem: async (data) => {
            const res = await apiFetch('/api/item', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ data })
            });
            return res.json();
          },
          items: async () => {
            const res = await apiFetch('/api/items');
            return res.json();
          },
          export: async () => {
            const r = await apiFetch('/api/export');
            return r.json();
          },
          import: async (payload) => {
            const r = await apiFetch('/api/import', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            return r.json();
          },
          clients: async () => {
            const res = await apiFetch('/api/clients');
            return res.json();
          },
          addClient: async (payload) => {
            const res = await apiFetch('/api/client', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            return res.json();
          },
          updateClient: async (id, payload) => {
            const res = await apiFetch('/api/client', {
              method:'PUT',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(Object.assign({}, payload, { id }))
            });
            return res.json();
          },
          deleteClient: async (id) => {
            const res = await apiFetch('/api/client?id=' + encodeURIComponent(id), { method:'DELETE' });
            return res.json();
          }
        };
        window.appDB = Object.assign(window.appDB || {}, api);
      })();
    </script>
    <script>
      // Automatic sync between localStorage and server-side kv store.
      (function(){
        // Use prototype overrides to make sure we catch all setItem/removeItem calls,
        // even if some browsers block redefining them on the instance.
        const originSave = Storage.prototype.setItem.bind(window.localStorage);
        const originRemove = Storage.prototype.removeItem.bind(window.localStorage);

        function loadAppScript() {
          const mainScriptTag = document.getElementById('app-script');
          if (mainScriptTag && mainScriptTag.dataset.src) {
            const script = document.createElement('script');
            script.type = 'module';
            script.crossOrigin = true;
            script.src = mainScriptTag.dataset.src;
            document.head.appendChild(script);
          }
        }

        const SERVER_SYNC_EXCLUDED_KEYS = ['vogue_sesion', 'vogue_user'];

        function shouldSyncKey(key){
          return SERVER_SYNC_EXCLUDED_KEYS.indexOf(key) === -1;
        }

        async function fetchServerKV(){
          try{
            const res = await fetch('/api/export');
            if(!res.ok) return null;
            const data = await res.json();
            return data.kv || {};
          }catch(e){ console.warn('Could not fetch server KV', e); return null; }
        }

        async function serverSave(key, value){
          try{
            await fetch('/api/save', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ key, value }) });
          }catch(e){ console.warn('serverSave failed', e); }
        }

        async function serverDelete(key){
          try{
            await fetch('/api/delete?key=' + encodeURIComponent(key), { method: 'DELETE' });
          }catch(e){ console.warn('serverDelete failed', e); }
        }

        async function safePushAll(){
          if(window.appDB && typeof window.appDB.pushAllLocalToServer === 'function'){
            try{ return await window.appDB.pushAllLocalToServer(); }
            catch(e){ console.warn('pushAllLocalToServer failed', e); }
          }
          return { ok:false };
        }

        // On load: populate localStorage from server kv (server wins)
        document.addEventListener('DOMContentLoaded', async ()=>{
          try {
            const kv = await fetchServerKV();
            if(kv){
              try{
                Object.keys(kv).forEach(k=>{
                  if(!shouldSyncKey(k)) return; // no compartir sesión ni usuario
                  try{ localStorage.setItem(k, JSON.stringify(kv[k])); }catch(e){ localStorage.setItem(k, String(kv[k])); }
                });
                console.log('localStorage populated from server (kv keys):', Object.keys(kv));
              }catch(e){ console.warn('Error populating localStorage', e); }
            }
            // Push any existing local data back to the server to ensure it is persisted.
            await safePushAll();
          } catch(e) {
            console.error('Failed to fetch and populate initial data', e);
          } finally {
            // Always load the app script, even if the data fetch fails
            loadAppScript();
          }
        });

        // Override setItem to sync to server
        try{
          Storage.prototype.setItem = function(key, value){
            originSave(key, value);
            if(shouldSyncKey(key)){
              let parsed = value;
              try{ parsed = JSON.parse(value); }catch(e){ /* keep raw string */ }
              serverSave(key, parsed);
            }
          };
          Storage.prototype.removeItem = function(key){
            originRemove(key);
            if(shouldSyncKey(key)){
              serverDelete(key);
            }
          };
        }catch(e){ console.warn('Could not override localStorage methods', e); }

        // Periodic and on-hide sync to guarantee persistence even if overrides fail.
        setInterval(() => { safePushAll(); }, 15000);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden') safePushAll();
        });

        // Provide helper to push all current localStorage to server
        window.appDB = window.appDB || {};
        window.appDB.pushAllLocalToServer = async function(){
          try{
            for(let i=0;i<localStorage.length;i++){
              const k = localStorage.key(i);
              if(!shouldSyncKey(k)) continue;
              const v = localStorage.getItem(k);
              let parsed = v;
              try{ parsed = JSON.parse(v); }catch(e){}
              await serverSave(k, parsed);
            }
            return { ok:true };
          }catch(e){ console.error(e); return { ok:false, error: ''+e }; }
        };
      })();
    </script>
    <script>
      // Conectar el login de React con el backend (login/logout PHP).
      (function(){
        function isLoginForm(form){
          if(!(form instanceof HTMLFormElement)) return !1;
          return !!form.querySelector('input[type="password"]');
        }

        document.addEventListener('submit', function(ev){
          const form = ev.target;
          if(!isLoginForm(form)) return;
          if(!window.appDB || typeof window.appDB.login !== 'function') return;
          const userInput = form.querySelector('input[type="text"],input[type="email"]');
          const passInput = form.querySelector('input[type="password"]');
          if(!userInput || !passInput) return;
          const username = userInput.value || '';
          const password = passInput.value || '';
          if(!username || !password) return;
          // Llamar al backend para crear la sesión; React sigue manejando la UI.
          window.appDB.login(username, password).catch(function(){});
        }, true);

        document.addEventListener('click', function(ev){
          const btn = ev.target.closest('button');
          if(!btn) return;
          const text = (btn.textContent || '').toLowerCase();
          if(text.includes('cerrar sesión') || text.includes('cerrar sesion') || text.includes('logout')){
            if(window.appDB && typeof window.appDB.logout === 'function'){
              window.appDB.logout().catch(function(){});
            }
          }
        }, true);
      })();
    </script>
  </body>
</html>
